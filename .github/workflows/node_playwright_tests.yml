name: Playwright tests

on:
  workflow_call:
    inputs:
      shard:
        description: 'Shard number (e.g., 1)'
        required: true
        type: number
      total_shards:
        description: 'Total number of shards (e.g., 4)'
        required: true
        type: number
      node_version_file:
        description: 'Node version file'
        required: false
        type: string
        default: '.nvmrc'

permissions:
  contents: read

jobs:
  playwright_test:
    name: Shard ${{ inputs.shard }}/${{ inputs.total_shards }}
    runs-on: ubuntu-latest
    steps:
      - uses: actions/checkout@v5

      - name: Use Node.js
        uses: actions/setup-node@v6
        with:
          node-version-file: ${{ inputs.node_version_file }}

      - name: Download build artifacts
        uses: actions/download-artifact@v6
        with:
          name: npm_build_artifacts

      - name: Install dependencies
        run: npm ci

      - name: Install Playwright browsers
        run: npx playwright install chromium --with-deps

      - name: Download wiremock
        run: curl -o wiremock.jar https://repo1.maven.org/maven2/org/wiremock/wiremock-standalone/3.9.1/wiremock-standalone-3.9.1.jar

      - name: Start wiremock and app
        run: |
          nohup java -jar wiremock.jar --port 9091 &
          nohup npm run start-feature &
          sleep 5

      - name: Run Playwright tests
        run: npx playwright test --shard=${{ inputs.shard }}/${{ inputs.total_shards }} --reporter=blob,list,html,junit

      - name: Upload blob report
        if: ${{ !cancelled() }}
        uses: actions/upload-artifact@v5
        with:
          name: playwright-blob-shard-${{ inputs.shard }}
          path: blob-report/
          retention-days: 1

      - name: Upload test results
        if: ${{ !cancelled() }}
        uses: actions/upload-artifact@v5
        with:
          name: playwright-results-shard-${{ inputs.shard }}
          path: |
            test_results/playwright/
